/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins
{
	// Reckon versioning plugin
	// Usage: ./gradlew [TASK] -Preckon.scope=minor|major -Preckon.stage=rc|final (default is minor and first stage in the list (ordered alphabetically)) -Dorg.ajoberstar.grgit.auth.username=<token>
	id 'org.ajoberstar.reckon' version '0.12.0'

	// Grgit plugin
	id 'org.ajoberstar.grgit' version '4.0.2'
}

// Load build's functions
apply from: "build.groovy"

//
// Versioning (must be the first plugin setup)
//

// Add this setion to avoid:
// 	Could not evaluate onlyIf predicate for task ':reckonTagCreate'.
// 	> java.lang.String cannot be cast to org.ajoberstar.reckon.gradle.ReckonPlugin$DelayedVersion
gradle.taskGraph.beforeTask { Task task ->
	if (task.name == 'reckonTagCreate') {
		project.version = originalProjectVersionObject
	}
}
gradle.taskGraph.afterTask { Task task ->
	if (task.name == 'reckonTagCreate') {
		project.version = originalProjectVersionObject.toString()
	}
}

// The Reckon plugin
reckon {
	scopeFromProp()
	stageFromProp("${reckon_staging_stage_name}","${reckon_production_stage_name}","${reckon_FINAL_stage_name}")
}

// Reckon helpers
task printVersion
task stampVersion(dependsOn: reckonTagCreate)
task publishVersion(dependsOn: reckonTagPush)

// These properties must be defined after the reckon plugin is set up!
ext.originalProjectVersionObject = project.version
ext.productVersion = manifestVersion()
ext.productTag = manifestVersion(false)

// Pre-Defined project properties
project.description = 'A simple Gradle based Semantic Versioning (2.0) facilitator via smart Git tagging'

// Pre-Defined project properties
//project.description = 'The Echo demo product'
project.version = originalProjectVersionObject.toString()
